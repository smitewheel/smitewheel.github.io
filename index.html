<!DOCTYPE html>
<html>
    <!--
        Code based on this codepen example:
        https://codepen.io/barney-parker/pen/OPyYqy
    -->
    <head>
        <title>SmiteWheel</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body id="main">
        <div class="row">
            <div class="col-2-sm"></div>
            <div class="col-6-sm">
                <center>
                    <input type="button" id="darkmode" value="Dark Mode"/>
                </center>
            </div>
            <div class="col-4-sm"></div>
        </div>
        <div class="row">
            <div class="col-2-sm">
                <div class="row">
                    <div class="col-6-sm">
                        <input id="Assassin" class="buttons" type="button"/>
                        <center><p>Assassins</p></center>
                    </div>
                    <div class="col-6-sm">
                        <input id="Guardian" class="buttons" type="button"/>
                        <center><p>Guardians</p></center>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6-sm">
                        <input id="Hunter" class="buttons" type="button"/>
                        <center><p>Hunters</p></center>
                    </div>
                    <div class="col-6-sm">
                        <input id="Mage" class="buttons" type="button"/>
                        <center><p>Mages</p></center>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6-sm">
                        <input id="Warrior" class="buttons" type="button"/>
                        <center><p>Warriors</p></center>
                    </div>
                    <div class="col-6-sm">
                        <input id="tiggzMode" class="buttons" type="button"/>
                        <center><p>TiggzMode</p></center>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6-sm">
                        <input class="buttons" type="button" value="Reset" id="reset"/>
                    </div>
                    <div class="col-6-sm">
                        <input class="buttons" type="button" value="SPIN" id="spin" />  
                    </div>
                </div>
            </div>
            <div class="col-6-sm">
                <canvas id="canvas" width="1000" height="1000"></canvas>
            </div>
            <div class="col-4-sm">
                <h1>Random God Wheel</h1>
                <p>For people who don't know who to play as, we've got you covered.</p>
                <div id="spin_result">
                    <h2 id="name"></h2>
                    <p id="desc"></p>
                    <img id="result" src="" alt="" />
                </div>
            </div>
        </div>
        <script>
            const tiggzMode = [
                "Agni", "Ah Muzen Cab", "Ah Puch", "Anhur", 
                "Anubis", "Aphrodite", "Apollo", "Artemis",
                "Baba Yaga", "Bastet", "Camazotz", "Cerberus",
                "Cernunnos", "Chaac", "Chang'e", "Chernobog",
                "Chiron", "Chronos", "Cupid", "Discordia",
                "Fafnir", "Freya", "Geb", "Hachiman",
                "He Bo", "Heimdallr", "Hera", "Hou Yi",
                "Isis", "Izanami", "Janus", "Jing Wei",
                "Khepri", "Kukulkan", "Kuzenbo", "Medusa",
                "Merlin", "Ne Zha", "Neith", "Nox",
                "Nu Wa", "Olorun", "Persephone", "Poseidon",
                "Ra", "Raijin", "Rama", "Ravana",
                "Scylla", "Skadi", "Sol", "Sylvanus",
                "Thoth", "Vulcan", "Xbalanque", "Xing Tian",
                "Yemoja", "Zeus",
            ]

            var options = getFreshGods();

            var startAngle = 0;
            var arc = Math.PI / (options.length / 2);
            var spinTimeout = null;

            var spinArcStart = 10;
            var spinTime = 0;
            var spinTimeTotal = 0;

            var ctx;

            var darkmodeOn = false;

            // Register event listeners
            var spinner = document.getElementById("spin");
            spinner.addEventListener("click", spin);
            var assassins = document.getElementById("Assassin");
            assassins.addEventListener("click", filter);
            var guardians = document.getElementById("Guardian");
            guardians.addEventListener("click", filter);
            var hunters = document.getElementById("Hunter");
            hunters.addEventListener("click", filter);
            var mages = document.getElementById("Mage");
            mages.addEventListener("click", filter);
            var warriors = document.getElementById("Warrior");
            warriors.addEventListener("click", filter);
            var tiggz = document.getElementById("tiggzMode");
            tiggz.addEventListener("click", enableTiggzMode);
            var reset = document.getElementById("reset");
            reset.addEventListener("click", clear);
            var toggleDark = document.getElementById("darkmode");
            toggleDark.addEventListener("click", toggleDarkmode);

            function toggleDarkmode() {
                var body = document.getElementById("main");
                if (darkmodeOn) {
                    body.style.backgroundColor = "#ffffff";
                    body.style.color = "#000000";
                    darkmodeOn = false
                    toggleDark.setAttribute("value", "Dark Mode");
                } else {
                    body.style.backgroundColor = "#474747";
                    body.style.color = "#dbdbdb";
                    darkmodeOn = true;
                    toggleDark.setAttribute("value", "Light Mode");
                }
            }

            function getFreshGods() {
                // Fetching the list of Gods straight from the source, means it's never out of date ;)
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", "https://cms.smitegame.com/wp-json/smite-api/all-gods/1", false);
                xmlHttp.send(null);
                var resp = xmlHttp.responseText;
                var decodedBody = JSON.parse(resp);
                // Loop through and shuffle the array of gods, so they aren't alphabetical
                for(var i = (decodedBody.length - 1 ); i > 0; i--){
                    const j = Math.floor(Math.random() * i)
                    const temp = decodedBody[i]
                    decodedBody[i] = decodedBody[j]
                    decodedBody[j] = temp
                }
                return decodedBody;
            }

            function clear(){
                options = getFreshGods();
                drawRouletteWheel();
            }

            function byte2Hex(n) {
                var nybHexString = "0123456789ABCDEF";
                return String(nybHexString.substr((n >> 4) & 0x0F,1)) + nybHexString.substr(n & 0x0F,1);
            }

            function RGB2Color(r,g,b) {
                return '#' + byte2Hex(r) + byte2Hex(g) + byte2Hex(b);
            }

            function getColor(item, maxitem) {
                var phase = 0;
                var center = 128;
                var width = 127;
                var frequency = Math.PI*2/maxitem;
                
                red   = Math.sin(frequency*item+2+phase) * width + center;
                green = Math.sin(frequency*item+0+phase) * width + center;
                blue  = Math.sin(frequency*item+4+phase) * width + center;
                
                return RGB2Color(red,green,blue);
            }

            function drawRouletteWheel() {
                var canvas = document.getElementById("canvas");
                arc = Math.PI / (options.length / 2);
                if (canvas.getContext) {
                    var outsideRadius = 400;
                    var textRadius = 320;
                    var insideRadius = 250;

                    ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.clearRect(0,0,500,500);

                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 2;

                    ctx.font = 'bold 12px Helvetica, Arial';

                    for(var i = 0; i < options.length; i++) {
                        var angle = startAngle + i * arc;
                        ctx.fillStyle = getColor(i, options.length);

                        ctx.beginPath();
                        ctx.arc(500, 500, outsideRadius, angle, angle + arc, false);
                        ctx.arc(500, 500, insideRadius, angle + arc, angle, true);
                        ctx.stroke();
                        ctx.fill();

                        ctx.save();
                        ctx.fillStyle = "black";
                        ctx.translate(500 + Math.cos(angle + arc / 2) * textRadius, 
                                        500 + Math.sin(angle + arc / 2) * textRadius);
                        ctx.rotate(angle);
                        var text = options[i].name;
                        ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                        ctx.restore();
                    } 

                    //Arrow
                    ctx.fillStyle = "black";
                    ctx.beginPath();
                    ctx.moveTo(500 - 4, 500 - (outsideRadius + 5));
                    ctx.lineTo(500 + 4, 500 - (outsideRadius + 5));
                    ctx.lineTo(500 + 4, 500 - (outsideRadius - 5));
                    ctx.lineTo(500 + 9, 500 - (outsideRadius - 5));
                    ctx.lineTo(500 + 0, 500 - (outsideRadius - 13));
                    ctx.lineTo(500 - 9, 500 - (outsideRadius - 5));
                    ctx.lineTo(500 - 4, 500 - (outsideRadius - 5));
                    ctx.lineTo(500 - 4, 500 - (outsideRadius + 5));
                    ctx.fill();
                }
            }

            function spin() {
                spinAngleStart = Math.random() * 10 + 10;
                spinTime = 0;
                spinTimeTotal = Math.random() * 3 + 4 * 1000;
                rotateWheel();
            }

            function filter(e) {
                options = getFreshGods();
                toFilter = e.target.id;
                options = options.filter(function(god) {
                    return god.role === " "+toFilter;
                })
                drawRouletteWheel();
            }

            function enableTiggzMode() {
                options = getFreshGods();
                options = options.filter(function(god){
                    return tiggzMode.includes(god.name)
                })
                drawRouletteWheel();
            }

            function rotateWheel() {
                spinTime += 30;
                if(spinTime >= spinTimeTotal) {
                    stopRotateWheel();
                    return;
                }
                var spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
                startAngle += (spinAngle * Math.PI / 180);
                drawRouletteWheel();
                spinTimeout = setTimeout('rotateWheel()', 30);
            }

            function stopRotateWheel() {
                clearTimeout(spinTimeout);
                var degrees = startAngle * 180 / Math.PI + 90;
                var arcd = arc * 180 / Math.PI;
                var index = Math.floor((360 - degrees % 360) / arcd);
                var god = options[index];
                ctx.save();
                ctx.font = 'bold 30px Helvetica, Arial';
                ctx.restore();

                // Set the result image
                var result = document.getElementById("result");
                result.setAttribute("src", god.card);
                result.setAttribute("alt", god.name);

                var name = document.getElementById("name");
                name.innerHTML=god.name;

                var desc = document.getElementById("desc");
                desc.innerHTML= god.title
            }

            function easeOut(t, b, c, d) {
                var ts = (t/=d)*t;
                var tc = ts*t;
                return b+c*(tc + -3*ts + 3*t);
            }

            drawRouletteWheel();
        </script>
        <footer>
            <div class="row">
                <div class="col-sm-3"></div>
                <div class="col-sm-2">
                    <p>Built following RouletteWheel example <a href="https://codepen.io/barney-parker/pen/OPyYqy">Codepen Reference</a></p>
                </div>
                <div class="col-sm-2">
                    <p><strong>Images provided by <a href="https://www.hirezstudios.com/">Hi-Rez Studios</a></strong></p>
                </div>
                <div class="col-sm-2">
                    <p>Simple Grid standalone CSS <a href="https://codepen.io/badcat/pen/qaLpRd">Codepen Reference</a></p>
                </div>
                <div class="col-sm-3"></div>
            </div>
        </footer>
    </body>
</html>